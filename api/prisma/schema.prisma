generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USUÁRIOS E AUTH ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(OPERADOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  GERENTE
  OPERADOR
}

// ==================== IMOBILIÁRIAS ====================

model Imobiliaria {
  id       String  @id @default(cuid())
  nome     String
  nomeKsi  String  @unique // Nome exato como aparece no KSI
  cnpj     String? @unique
  email    String?
  telefone String?
  whatsapp String?
  cidade   String?
  ativo    Boolean @default(true)

  // Dados financeiros
  diaPagamento   Int            @default(12) // Dia do mês para vencimento
  formaPagamento FormaPagamento @default(BOLETO)

  // Integração Asaas
  asaasCustomerId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tabelaPrecos TabelaPreco[]
  vistorias    Vistoria[]
  faturas      Fatura[]

  @@map("imobiliarias")
}

enum FormaPagamento {
  BOLETO
  PIX
  TRANSFERENCIA
}

// ==================== VISTORIADORES ====================

model Vistoriador {
  id       String  @id @default(cuid())
  nome     String
  nomeKsi  String  @unique // Nome exato como aparece no KSI
  cpf      String? @unique
  email    String?
  telefone String?
  whatsapp String?
  cidade   String?
  chavePix String?
  ativo    Boolean @default(true)

  // Token para acesso ao portal
  portalToken String? @unique @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tabelaPagamentos TabelaPagamentoVistoriador[]
  vistorias        Vistoria[]
  pagamentos       PagamentoVistoriador[]
  contestacoes     Contestacao[]

  @@map("vistoriadores")
}

// ==================== TABELAS DE PREÇOS ====================

model TipoServico {
  id        String  @id @default(cuid())
  codigo    String  @unique // Ex: "1.0", "2.1", "3.0"
  nome      String // Ex: "VISTORIA DE ENTRADA"
  descricao String?
  ativo     Boolean @default(true)

  tabelaPrecos     TabelaPreco[]
  tabelaPagamentos TabelaPagamentoVistoriador[]
  vistorias        Vistoria[]

  @@map("tipos_servico")
}

model FaixaMetragem {
  id            String @id @default(cuid())
  nome          String // Ex: "Até 150 m²"
  metrosMin     Float // Ex: 0
  metrosMax     Float // Ex: 150
  multiplicador Float  @default(1) // Ex: 1 = 1 vistoria, 1.5 = 1.5 vistorias
  ordem         Int    @default(0)

  tabelaPrecos     TabelaPreco[]
  tabelaPagamentos TabelaPagamentoVistoriador[]

  @@map("faixas_metragem")
}

// Tabela de preços: Imobiliária x TipoServico x FaixaMetragem
model TabelaPreco {
  id String @id @default(cuid())

  imobiliariaId String
  imobiliaria   Imobiliaria @relation(fields: [imobiliariaId], references: [id], onDelete: Cascade)

  tipoServicoId String
  tipoServico   TipoServico @relation(fields: [tipoServicoId], references: [id], onDelete: Cascade)

  faixaMetragemId String?
  faixaMetragem   FaixaMetragem? @relation(fields: [faixaMetragemId], references: [id], onDelete: SetNull)

  valorBase      Decimal  @db.Decimal(10, 2) // Valor base do serviço
  valorMobiliado Decimal? @db.Decimal(10, 2) // Adicional se mobiliado
  valorSemiMob   Decimal? @db.Decimal(10, 2) // Adicional se semi-mobiliado

  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([imobiliariaId, tipoServicoId, faixaMetragemId])
  @@map("tabelas_preco")
}

// Tabela de pagamentos: Vistoriador x TipoServico x FaixaMetragem
model TabelaPagamentoVistoriador {
  id String @id @default(cuid())

  vistoriadorId String
  vistoriador   Vistoriador @relation(fields: [vistoriadorId], references: [id], onDelete: Cascade)

  tipoServicoId String
  tipoServico   TipoServico @relation(fields: [tipoServicoId], references: [id], onDelete: Cascade)

  faixaMetragemId String?
  faixaMetragem   FaixaMetragem? @relation(fields: [faixaMetragemId], references: [id], onDelete: SetNull)

  valorBase      Decimal  @db.Decimal(10, 2)
  valorMobiliado Decimal? @db.Decimal(10, 2)
  valorSemiMob   Decimal? @db.Decimal(10, 2)

  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vistoriadorId, tipoServicoId, faixaMetragemId])
  @@map("tabelas_pagamento_vistoriador")
}

// ==================== VISTORIAS ====================

model Fechamento {
  id            String           @id @default(cuid())
  mesReferencia Int // Ex: 11 (novembro)
  anoReferencia Int // Ex: 2024
  status        StatusFechamento @default(RASCUNHO)

  dataImportacao DateTime? // Data da importação do arquivo
  dataEnvioVist  DateTime? // Data que enviou para vistoriadores
  dataEnvioImob  DateTime? // Data que enviou para imobiliárias
  dataFinalizado DateTime?

  totalVistorias Int     @default(0)
  totalReceber   Decimal @default(0) @db.Decimal(12, 2)
  totalPagar     Decimal @default(0) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vistorias  Vistoria[]
  faturas    Fatura[]
  pagamentos PagamentoVistoriador[]

  @@unique([mesReferencia, anoReferencia])
  @@map("fechamentos")
}

enum StatusFechamento {
  RASCUNHO
  IMPORTADO
  CALCULADO
  AGUARDANDO_VISTORIADORES
  EM_REVISAO
  AGUARDANDO_IMOBILIARIAS
  FATURADO
  FINALIZADO
}

model Vistoria {
  id String @id @default(cuid())

  // Referências
  fechamentoId String
  fechamento   Fechamento @relation(fields: [fechamentoId], references: [id], onDelete: Cascade)

  imobiliariaId String
  imobiliaria   Imobiliaria @relation(fields: [imobiliariaId], references: [id])

  vistoriadorId String
  vistoriador   Vistoriador @relation(fields: [vistoriadorId], references: [id])

  tipoServicoId String
  tipoServico   TipoServico @relation(fields: [tipoServicoId], references: [id])

  // Dados do KSI
  idKsi          String // ID original do KSI
  numeroContrato String?
  endereco       String
  cidade         String

  // Metragens
  areaInformada Float? // Área informada pela imobiliária
  areaAferida   Float? // Área medida pelo vistoriador
  areaFaturar   Float // Área final para faturamento

  // Mobiliado
  tipoMobilia TipoMobilia @default(NAO)

  // Datas
  dataAgenda     DateTime?
  dataFinalizado DateTime?

  // Valores calculados
  valorServico     Decimal @default(0) @db.Decimal(10, 2) // Valor a cobrar da imobiliária
  valorVistoriador Decimal @default(0) @db.Decimal(10, 2) // Valor a pagar ao vistoriador

  // Status
  status     StatusVistoria @default(IMPORTADA)
  observacao String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contestacoes Contestacao[]

  @@unique([fechamentoId, idKsi])
  @@index([fechamentoId])
  @@index([imobiliariaId])
  @@index([vistoriadorId])
  @@map("vistorias")
}

enum TipoMobilia {
  NAO
  SEMI
  SIM
}

enum StatusVistoria {
  IMPORTADA
  CALCULADA
  CONTESTADA
  REVISADA
  APROVADA
  FATURADA
}

// ==================== CONTESTAÇÕES ====================

model Contestacao {
  id String @id @default(cuid())

  vistoriaId String
  vistoria   Vistoria @relation(fields: [vistoriaId], references: [id], onDelete: Cascade)

  vistoriadorId String
  vistoriador   Vistoriador @relation(fields: [vistoriadorId], references: [id])

  tipo      TipoContestacao
  descricao String

  // Valores contestados
  areaContestada  Float?
  valorContestado Decimal? @db.Decimal(10, 2)

  status        StatusContestacao @default(PENDENTE)
  respostaAdmin String?

  createdAt    DateTime  @default(now())
  resolvidoAt  DateTime?
  resolvidoPor String?

  @@index([vistoriaId])
  @@index([status])
  @@map("contestacoes")
}

enum TipoContestacao {
  METRAGEM
  MOBILIADO
  TIPO_SERVICO
  VALOR
  OUTRO
}

enum StatusContestacao {
  PENDENTE
  ACEITA
  RECUSADA
  PARCIAL
}

// ==================== FINANCEIRO ====================

model Fatura {
  id String @id @default(cuid())

  fechamentoId String
  fechamento   Fechamento @relation(fields: [fechamentoId], references: [id], onDelete: Cascade)

  imobiliariaId String
  imobiliaria   Imobiliaria @relation(fields: [imobiliariaId], references: [id])

  numero         String   @unique
  valor          Decimal  @db.Decimal(12, 2)
  dataVencimento DateTime

  // Integração Asaas
  asaasPaymentId     String?
  asaasBoletoUrl     String?
  asaasPixQrCode     String?
  asaasPixCopiaECola String?

  status        StatusFatura @default(PENDENTE)
  dataPagamento DateTime?
  valorPago     Decimal?     @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, dataVencimento])
  @@index([fechamentoId])
  @@index([imobiliariaId])
  @@map("faturas")
}

enum StatusFatura {
  PENDENTE
  ENVIADA
  VENCIDA
  PAGA
  CANCELADA
}

model PagamentoVistoriador {
  id String @id @default(cuid())

  fechamentoId String
  fechamento   Fechamento @relation(fields: [fechamentoId], references: [id], onDelete: Cascade)

  vistoriadorId String
  vistoriador   Vistoriador @relation(fields: [vistoriadorId], references: [id])

  valor        Decimal  @db.Decimal(12, 2)
  dataPrevista DateTime

  status        StatusPagamento @default(PENDENTE)
  dataPagamento DateTime?
  comprovante   String? // URL do comprovante

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fechamentoId])
  @@index([vistoriadorId])
  @@map("pagamentos_vistoriador")
}

enum StatusPagamento {
  PENDENTE
  AGENDADO
  PAGO
  CANCELADO
}

// ==================== AUDITORIA ====================

model AuditLog {
  id String @id @default(cuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action   String // Ex: "vistoria.update", "fatura.create"
  entity   String // Ex: "Vistoria", "Fatura"
  entityId String

  oldData Json?
  newData Json?

  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
